# Cell Line Inspector Guide

## Overview

The **Cell Line Inspector** is a dashboard tool that provides visual validation of the parametric protocols generated by cell_OS. It allows users to inspect the exact steps, reagents, volumes, and costs for thaw, passage, and feed operations across different cell lines and vessels.

## Purpose

The inspector serves several key functions:

1. **Transparency**: Shows exactly what the automation engine will execute
2. **Validation**: Confirms that YAML configurations produce expected protocols
3. **Cost Estimation**: Provides upfront cost visibility for different operations
4. **Debugging**: Helps identify configuration issues before running experiments

## How It Works

The Cell Line Inspector uses the same engine that drives actual workflows:

- **ProtocolResolver**: Reads configuration from `data/cell_lines.yaml`
- **ParametricOps**: Generates concrete unit operations with costs
- **No Custom Logic**: What you see is what the system will execute

## Using the Inspector

### 1. Access the Inspector

Navigate to the **üß¨ Cell Line Inspector** tab in the cell_OS dashboard.

### 2. Select Parameters

Choose three parameters:

- **Cell Line**: The cell line to inspect (e.g., iPSC, HEK293, A549)
- **Vessel**: The culture vessel (e.g., flask_t75, flask_t25, plate_6well)
- **Operation**: The operation type (thaw, passage, or feed)

### 3. Resolve Protocol

Click the **üîç Resolve Protocol** button to generate the protocol.

### 4. Review Results

The inspector displays:

- **Protocol Steps**: Numbered list of all operations
- **Step Details**: Description, reagent, volume, and cost per step
- **Cost Summary**: Total estimated cost and reagent breakdown
- **Metrics**: Total steps, cost, and number of reagents

## Example Use Cases

### Validating a New Cell Line Configuration

After adding a new cell line to `data/cell_lines.yaml`:

1. Open the Cell Line Inspector
2. Select your new cell line
3. Test each operation type (thaw, passage, feed)
4. Verify:
   - Coating is applied when required
   - Correct media is used
   - Volumes match your specifications
   - Costs are reasonable

### Comparing Cell Lines

To understand cost differences between cell lines:

1. Resolve the same operation for different cell lines
2. Compare total costs and reagent usage
3. Identify cost drivers (e.g., expensive media, coating requirements)

### Debugging Protocol Issues

If a workflow fails or produces unexpected results:

1. Use the inspector to see the exact protocol steps
2. Check that volumes and reagents match expectations
3. Verify configuration in `data/cell_lines.yaml`
4. Make adjustments and re-inspect

## Configuration Source

All protocols shown in the inspector are driven by `data/cell_lines.yaml`. The configuration includes:

### Vessel Scaling

**NEW**: The system now automatically scales volumes for different vessel sizes! You only need to configure one reference vessel (typically T75), and the system will automatically calculate appropriate volumes for T25, T175, plates, and other vessels.

**How it works:**
- Define volumes for a reference vessel (e.g., T75 with 15 mL working volume)
- When requesting a different vessel (e.g., T25 with 5 mL working volume), volumes are automatically scaled
- Scaling factor = Target working volume / Reference working volume
- Example: T25 (5 mL) from T75 (15 mL) = 0.333x scale factor

**Example:**
```yaml
thaw:
  reference_vessel: T75  # Define once for T75
  T75:
    volumes_mL:
      media_aliquot: 40.0
      pre_warm: 15.0
      # ... other volumes
```

When you request T25, volumes are automatically scaled:
- `media_aliquot`: 40.0 √ó 0.333 = 13.3 mL
- `pre_warm`: 15.0 √ó 0.333 = 5.0 mL

When you request T175, volumes are automatically scaled:
- `media_aliquot`: 40.0 √ó 2.0 = 80.0 mL
- `pre_warm`: 15.0 √ó 2.0 = 30.0 mL

**Override for specific vessels:**
If you need custom volumes for a specific vessel, just add that vessel type to the configuration:
```yaml
thaw:
  reference_vessel: T75
  T75:
    volumes_mL:
      media_aliquot: 40.0
      # ...
  T175:  # Custom config for T175
    volumes_mL:
      media_aliquot: 100.0  # Custom value, not scaled
      # ...
```

### Profile Block
```yaml
profile:
  cell_type: "iPSC"
  coating_required: true
  coating_reagent: "laminin_521"
  dissociation_method: "versene"
  media: "mtesr_plus_kit"
  # ... other metadata
```

### Thaw Block
```yaml
thaw:
  reference_vessel: T75
  T75:
    volumes_mL:
      media_aliquot: 40.0
      pre_warm: 15.0
      wash_aliquot: 5.0
      wash_vial: 1.0
      resuspend: 1.0
      transfer: 1.0
```

### Feed Block
```yaml
feed:
  reference_vessel: T75
  T75:
    volume_ml: 15.0
    schedule:
      interval_days: 1
```

### Passage Block
```yaml
passage:
  reference_vessel: T75
  T75:
    volumes_mL_reference:
      wash_1: 10.0
      detach: 5.0
      # ... other volumes
    incubation:
      detach:
        temp_C: 37
        minutes: 10
```

## Adding a New Cell Line

To add a new cell line and validate it with the inspector:

1. **Edit `data/cell_lines.yaml`**:
   ```yaml
   NewCellLine:
     display_name: "My New Cell Line"
     growth_media: dmem_high_glucose
     wash_buffer: dpbs
     detach_reagent: trypsin_edta
     coating: null
     
     profile:
       cell_type: "immortalized"
       coating_required: false
       # ... other profile fields
     
     passage:
       reference_vessel: T75
       # ... passage configuration
     
     thaw:
       reference_vessel: T75
       # ... thaw configuration
     
     feed:
       reference_vessel: T75
       # ... feed configuration
   ```

2. **Refresh the Dashboard**: Reload the page to pick up the new configuration

3. **Inspect Each Operation**:
   - Select your new cell line
   - Test thaw, passage, and feed
   - Verify all steps are correct

4. **Iterate**: Adjust YAML configuration and re-inspect until satisfied

## Technical Details

### Protocol Resolution

The inspector uses these resolution paths:

- **Passage**: `ProtocolResolver.resolve_passage_protocol(cell_line, vessel_type)`
- **Thaw**: `ParametricOps.op_thaw(vessel_id, cell_line=cell_line)`
- **Feed**: `ParametricOps.op_feed(vessel_id, cell_line=cell_line)`

All methods respect the `self.resolver` configuration and fall back to legacy behavior if needed.

### Cost Calculation

Costs are calculated using:

- **Inventory**: `data/raw/pricing.yaml` or SQLite database
- **Material Costs**: Reagents, consumables, vessels
- **Instrument Costs**: Equipment usage time

### Error Handling

The inspector gracefully handles:

- Unknown cell lines (displays error message)
- Unknown vessels (displays error message)
- Missing configuration (falls back to defaults)
- Resolution failures (shows detailed error)

## Best Practices

1. **Always Inspect New Configurations**: Before running experiments, validate protocols in the inspector

2. **Compare with Legacy**: If migrating from hardcoded protocols, compare inspector output with legacy behavior

3. **Document Deviations**: If you see unexpected behavior, note it and investigate the YAML configuration

4. **Use for Training**: The inspector is excellent for teaching new users how cell_OS works

5. **Cost Planning**: Use cost estimates for budget planning and resource allocation

## Troubleshooting

### "Unknown cell line" Error

- Check that the cell line exists in `data/cell_lines.yaml`
- Verify spelling matches exactly (case-sensitive)
- Refresh the dashboard after adding new cell lines

### Missing Steps

- Ensure all required configuration blocks exist (profile, thaw/passage/feed)
- Check for YAML syntax errors
- Verify reference_vessel is defined

### Incorrect Volumes

- Review `volumes_mL` or `volumes_mL_reference` in YAML
- Check if scaling is enabled (reference_vessel pattern)
- Verify vessel properties in `data/raw/vessels.yaml`

### Cost Seems Wrong

- Check pricing in `data/raw/pricing.yaml` or inventory database
- Verify reagent IDs match between YAML and pricing
- Look for missing consumables in cost calculation

## Related Documentation

- [Passaging Architecture Proposal](../architecture/passaging_architecture_proposal.md)
- [Cell Lines Configuration](../../data/cell_lines.yaml)
- [Protocol Resolver](../../src/cell_os/protocol_resolver.py)
- [Parametric Operations](../../src/cell_os/unit_ops/parametric.py)

## Future Enhancements

Potential improvements to the inspector:

- **Side-by-Side Comparison**: Compare protocols for multiple cell lines simultaneously
- **Export Protocols**: Download protocol steps as PDF or CSV
- **Timeline View**: Show protocol duration and scheduling
- **Resource Allocation**: Predict equipment and staff requirements
- **Batch Planning**: Estimate costs for multiple runs
