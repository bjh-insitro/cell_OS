# EL406 Dispenser/Washer - Cell Painting Instrument
# Used for fixation, permeabilization, staining, and washing
# 8-channel manifold with serpentine processing pattern

instrument_id: "el406_cellpainting"
instrument_purpose: "cell_painting_assay"
usage: "Cell Painting protocol: fixation, permeabilization, staining, washing"

manifold_type: "el406_8channel"
num_channels: 8
num_pins: 8

# Processing pattern: serpentine (odd rows L→R, even rows R→L)
processing_pattern:
  odd_rows: "left_to_right"   # A, C, E, G, I, K, M, O: columns 1→12/24
  even_rows: "right_to_left"  # B, D, F, H, J, L, N, P: columns 24/12→1

# Timing parameters (seconds)
timing:
  dispense_rate: 1.0         # ~1 second per well dispense
  aspiration_rate: 0.8       # ~0.8 seconds per well aspiration
  row_transition: 2.0        # 2 seconds to move to next row (odd→odd or even→even)
  pass_transition: 5.0       # 5 seconds between pass 1→pass 2 (odd rows→even rows)

# Pin-specific hardware variation (8-channel manifold)
pin_characteristics:
  num_pins: 8
  pin_to_row_mapping:
    pin_1: ["A", "I"]  # 384-well: rows A and I
    pin_2: ["B", "J"]
    pin_3: ["C", "K"]
    pin_4: ["D", "L"]
    pin_5: ["E", "M"]
    pin_6: ["F", "N"]
    pin_7: ["G", "O"]
    pin_8: ["H", "P"]

  per_pin_variation:
    volume_cv: 0.02-0.05      # 2-5% CV per pin (pin-to-pin differences)
    reagent_mixing: "Each pin has slightly different mixing characteristics affecting stain uniformity"
    systematic_bias: "Each pin has persistent offset from nominal dispense volume and mixing quality"

  effects:
    row_specific_bias: |
      Each row gets consistent treatment from same pin throughout Cell Painting protocol:
      - Row A always uses Pin 1 (systematic volume, mixing characteristics)
      - Row B always uses Pin 2 (different volume, different mixing)
      - etc.

      Result: ROW-WISE systematic biases in:
      1. Fixative concentration (volume variation affects fixation strength)
      2. Stain intensity (volume + mixing affects antibody binding)
      3. Background signal (wash efficiency varies by pin)

      These biases are DETERMINISTIC and LEARNABLE:
      - Row A wells consistently get Pin 1 characteristics across ALL protocol steps
      - Row C wells consistently get Pin 3 characteristics
      - Agent can learn "Row A always runs bright, Row E always runs dim"

    interaction_with_serpentine_gradient: |
      Pin-specific effects MULTIPLY with serpentine temporal gradients:
      - A1: Early timing (processed first) × Pin 1 bias (row A) × column position
      - P24: Late timing (processed last) × Pin 8 bias (row P) × column position

      Total effect = serpentine_temporal_gradient × pin_bias

      Example: Primary stain dispense
      - Pin 1 dispenses 3% high volume (more antibody)
      - A1 is early in serpentine (longer incubation before wash)
      - A1 gets 3% more stain + 10% longer incubation = 13.3% intensity boost

      Example: Wash step
      - Pin 5 has slightly better mixing (cleaner wash)
      - Row E gets lower background despite temporal position

    cumulative_across_protocol_steps: |
      Pin biases compound throughout multi-step protocol:

      Fix step: Row A gets Pin 1 volume offset
      Wash 1: Row A gets Pin 1 mixing characteristic
      Permeabilize: Row A gets Pin 1 volume offset AGAIN
      Wash 2: Row A gets Pin 1 mixing characteristic AGAIN
      Primary stain: Row A gets Pin 1 volume offset AGAIN (CRITICAL STEP)
      Wash 3-4: Row A gets Pin 1 mixing characteristic 4× MORE

      By imaging, Row A has Pin 1 signature from 8+ protocol steps

      This creates STRONG row-wise structure that's independent of:
      - Column position (temporal gradient)
      - Cell line (biological baseline)
      - Culture instrument (different EL406 with different pin calibrations)

# Parametric Unit Ops that use this EL406
parametric_unit_ops:
  - op_name: "op_dispense"
    usage: "Dispense fixative, permeabilization buffer, stain cocktails"
    hardware: "EL406 Cell Painting"
    temporal_gradient: true
    context: "cell_painting"

  - op_name: "op_aspirate"
    usage: "Remove fixative, wash buffers"
    hardware: "EL406 Cell Painting"
    temporal_gradient: true
    context: "cell_painting"

  - op_name: "op_wash"
    usage: "Multi-cycle aspirate + dispense for washing"
    hardware: "EL406 Cell Painting"
    temporal_gradient: true
    context: "cell_painting"

# Cell Painting protocol steps mapped to parametric unit ops
# Each step uses EL406 and creates temporal gradient
cell_painting_protocol_steps:
  - name: "fix"
    parametric_unit_ops: ["op_dispense"]
    operation: "dispense_and_incubate"
    reagent: "4% PFA"
    nominal_incubation: 1200  # 20 min nominal, but varies by well position
    temporal_gradient_effect: "fixation_quality"
    notes: "Dispense PFA using EL406 serpentine pattern. A1 gets fixed first, sits longest before wash."

  - name: "wash_post_fix"
    parametric_unit_ops: ["op_aspirate", "op_dispense"]
    operation: "aspirate_and_dispense"
    cycles: 3
    temporal_gradient_effect: "residual_fixative"
    notes: "3× aspirate/dispense wash cycles. A1 washed first (shortest fix time), P1 washed last (longest fix time)."

  - name: "permeabilize"
    parametric_unit_ops: ["op_dispense"]
    operation: "dispense_and_incubate"
    reagent: "0.1% Triton X-100"
    nominal_incubation: 900   # 15 min nominal
    temporal_gradient_effect: "permeabilization_depth"
    notes: "Dispense Triton X-100 using EL406. Creates permeabilization gradient."

  - name: "wash_post_permeabilize"
    parametric_unit_ops: ["op_aspirate", "op_dispense"]
    operation: "aspirate_and_dispense"
    cycles: 3
    notes: "Remove permeabilization buffer with 3× wash."

  - name: "primary_stain"
    parametric_unit_ops: ["op_dispense"]
    operation: "dispense_and_incubate"
    reagent: "Cell Painting cocktail (primary)"
    nominal_incubation: 1800  # 30 min nominal
    temporal_gradient_effect: "staining_intensity"
    notes: "CRITICAL: Main source of staining gradient. A1 stains longest, P1 stains shortest."

  - name: "wash_post_primary"
    parametric_unit_ops: ["op_aspirate", "op_dispense"]
    operation: "aspirate_and_dispense"
    cycles: 4
    temporal_gradient_effect: "background_signal"
    notes: "4× wash to remove unbound stain. Washing order affects background."

  - name: "secondary_stain"
    parametric_unit_ops: ["op_dispense"]
    operation: "dispense_and_incubate"
    reagent: "Secondary antibodies"
    nominal_incubation: 1800  # 30 min nominal
    temporal_gradient_effect: "signal_amplification"
    notes: "Secondary antibody amplification. Adds to gradient if protocol uses secondaries."

  - name: "final_wash"
    parametric_unit_ops: ["op_aspirate", "op_dispense"]
    operation: "aspirate_and_dispense"
    cycles: 5
    temporal_gradient_effect: "background_noise"
    notes: "5× final wash before imaging. Last chance to equalize background."

# Expected artifacts from serpentine pattern
expected_artifacts:
  gradient_type: "serpentine"

  # Wells processed first (A1, C1, E1, ...) get:
  early_wells:
    - "Longer fixation time (last to be washed)"
    - "Longer staining time (last to be washed)"
    - "Higher signal intensity (more antibody binding)"
    - "Potentially over-fixed (harsh)"
    - "Lower background (more thorough washing)"

  # Wells processed last (B1, D1, F1, ... P1) get:
  late_wells:
    - "Shorter fixation time (first to be washed)"
    - "Shorter staining time (first to be washed)"
    - "Lower signal intensity (less antibody binding)"
    - "Potentially under-fixed (weak)"
    - "Higher background (less wash time)"

  # Magnitude (typical)
  gradient_magnitude:
    min_delta_time: 0         # A1 processed first
    max_delta_time: 240       # P1 processed last (~4 min spread for 384-well)
    typical_signal_gradient: "10-15% intensity variation corner-to-corner"
    cv_contribution: "3-5% CV added to vehicle islands"
    primary_stain_contribution: "8-12% gradient (largest single contributor)"
    cumulative_protocol: "10-15% total (all steps combined)"

# Plate format support
supported_formats:
  - plate_format: 384
    rows: ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P"]
    columns: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]
    total_dispense_time: 240  # ~4 minutes for full plate

  - plate_format: 96
    rows: ["A","B","C","D","E","F","G","H"]
    columns: [1,2,3,4,5,6,7,8,9,10,11,12]
    total_dispense_time: 60   # ~1 minute for full plate

# Implementation notes
implementation_notes: |
  EL406 Cell Painting creates DETERMINISTIC temporal gradients in Cell Painting assay.

  Key differences from EL406 Culture:
  - Different instrument (independent calibration/wear from culture EL406)
  - Used later in experiment lifecycle (after culture/treatment)
  - Gradients affect MEASUREMENT quality (fixation, staining)
  - Independent from culture gradients (multiplicative effect)

  Integration with Cell Painting assay:
  - Calculate well processing order from row/column
  - Compute time delta from A1 (reference well)
  - Apply time-dependent bias to stain factors
  - This is ADDITIVE to existing stain_cv (plate-level variation)

  Example: Well M23 (late in pass 1)
  - Processed at t ≈ 200s after A1
  - Gets 200s less fixation before wash → under-fixed
  - Gets 200s less staining before wash → lower signal
  - Apply ~8% negative bias to stain factor

  Primary stain step dominates:
  - 30-minute incubation + 4-minute dispense gradient
  - A1: stains for 34 minutes (processed first, washed last)
  - P1: stains for 30 minutes (processed last, washed first)
  - Creates 8-12% intensity gradient just from this step

  Interaction with Culture EL406:
  - Culture EL406 creates biological gradient (growth, density)
  - Cell Painting EL406 creates measurement gradient (signal intensity)
  - Total effect: PRODUCT of both gradients
  - Example: If A1 has 5% higher density (culture) and 10% higher signal (painting)
    → A1 shows 15.5% total elevation vs P1
  - Agent must learn TWO independent systematic artifacts

  This gradient is LEARNABLE by agent:
  - Corner wells (A1, A24, P1, P24) show systematic bias
  - Agent can learn "A1 always runs hot, P1 always runs cold"
  - Combines with per-well biology AND culture gradient to create well identity
  - Total systematic bias per well = baseline × culture_gradient × painting_gradient
