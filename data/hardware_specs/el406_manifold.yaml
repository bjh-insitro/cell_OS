# EL406 Dispenser/Washer Hardware Specification
# 8-channel manifold with serpentine processing pattern

manifold_type: "el406_8channel"
num_channels: 8

# Processing pattern: serpentine (odd rows L→R, even rows R→L)
processing_pattern:
  odd_rows: "left_to_right"   # A, C, E, G, I, K, M, O: columns 1→12/24
  even_rows: "right_to_left"  # B, D, F, H, J, L, N, P: columns 24/12→1

# Timing parameters (seconds)
timing:
  dispense_rate: 1.0         # ~1 second per well dispense
  aspiration_rate: 0.8       # ~0.8 seconds per well aspiration
  row_transition: 2.0        # 2 seconds to move to next row (odd→odd or even→even)
  pass_transition: 5.0       # 5 seconds between pass 1→pass 2 (odd rows→even rows)

# Parametric Unit Ops that use EL406
# These operations call the EL406 hardware and are affected by serpentine pattern
parametric_unit_ops:
  - op_name: "op_dispense"
    usage: "Dispense fixative, permeabilization buffer, stain cocktails"
    hardware: "EL406 8-channel manifold"
    temporal_gradient: true

  - op_name: "op_aspirate"
    usage: "Remove media, fixative, wash buffers"
    hardware: "EL406 8-channel manifold"
    temporal_gradient: true

  - op_name: "op_wash"
    usage: "Multi-cycle aspirate + dispense for washing"
    hardware: "EL406 8-channel manifold"
    temporal_gradient: true

# Cell Painting protocol steps mapped to parametric unit ops
# Each step uses EL406 and creates temporal gradient
protocol_steps:
  - name: "fix"
    parametric_unit_ops: ["op_dispense"]
    operation: "dispense_and_incubate"
    reagent: "4% PFA"
    nominal_incubation: 1200  # 20 min nominal, but varies by well position
    temporal_gradient_effect: "fixation_quality"
    notes: "Dispense PFA using EL406 serpentine pattern. A1 gets fixed first, sits longest before wash."

  - name: "wash_post_fix"
    parametric_unit_ops: ["op_aspirate", "op_dispense"]
    operation: "aspirate_and_dispense"
    cycles: 3
    temporal_gradient_effect: "residual_fixative"
    notes: "3× aspirate/dispense wash cycles. A1 washed first (shortest fix time), P1 washed last (longest fix time)."

  - name: "permeabilize"
    parametric_unit_ops: ["op_dispense"]
    operation: "dispense_and_incubate"
    reagent: "0.1% Triton X-100"
    nominal_incubation: 900   # 15 min nominal
    temporal_gradient_effect: "permeabilization_depth"
    notes: "Dispense Triton X-100 using EL406. Creates permeabilization gradient."

  - name: "wash_post_permeabilize"
    parametric_unit_ops: ["op_aspirate", "op_dispense"]
    operation: "aspirate_and_dispense"
    cycles: 3
    notes: "Remove permeabilization buffer with 3× wash."

  - name: "primary_stain"
    parametric_unit_ops: ["op_dispense"]
    operation: "dispense_and_incubate"
    reagent: "Cell Painting cocktail (primary)"
    nominal_incubation: 1800  # 30 min nominal
    temporal_gradient_effect: "staining_intensity"
    notes: "CRITICAL: Main source of staining gradient. A1 stains longest, P1 stains shortest."

  - name: "wash_post_primary"
    parametric_unit_ops: ["op_aspirate", "op_dispense"]
    operation: "aspirate_and_dispense"
    cycles: 4
    temporal_gradient_effect: "background_signal"
    notes: "4× wash to remove unbound stain. Washing order affects background."

  - name: "secondary_stain"
    parametric_unit_ops: ["op_dispense"]
    operation: "dispense_and_incubate"
    reagent: "Secondary antibodies"
    nominal_incubation: 1800  # 30 min nominal
    temporal_gradient_effect: "signal_amplification"
    notes: "Secondary antibody amplification. Adds to gradient if protocol uses secondaries."

  - name: "final_wash"
    parametric_unit_ops: ["op_aspirate", "op_dispense"]
    operation: "aspirate_and_dispense"
    cycles: 5
    temporal_gradient_effect: "background_noise"
    notes: "5× final wash before imaging. Last chance to equalize background."

# Expected artifacts from serpentine pattern
expected_artifacts:
  gradient_type: "serpentine"

  # Wells processed first (A1, C1, E1, ...) get:
  early_wells:
    - "Longer fixation time (last to be washed)"
    - "Longer staining time (last to be washed)"
    - "Higher signal intensity (more antibody binding)"
    - "Potentially over-fixed (harsh)"

  # Wells processed last (B1, D1, F1, ... P1) get:
  late_wells:
    - "Shorter fixation time (first to be washed)"
    - "Shorter staining time (first to be washed)"
    - "Lower signal intensity (less antibody binding)"
    - "Potentially under-fixed (weak)"

  # Magnitude (typical)
  gradient_magnitude:
    min_delta_time: 0         # A1 processed first
    max_delta_time: 240       # P1 processed last (~4 min spread for 384-well)
    typical_signal_gradient: "10-15% intensity variation corner-to-corner"
    cv_contribution: "3-5% CV added to vehicle islands"

# Plate format support
supported_formats:
  - plate_format: 384
    rows: ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P"]
    columns: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]
    total_dispense_time: 240  # ~4 minutes for full plate

  - plate_format: 96
    rows: ["A","B","C","D","E","F","G","H"]
    columns: [1,2,3,4,5,6,7,8,9,10,11,12]
    total_dispense_time: 60   # ~1 minute for full plate

# Notes for implementation
implementation_notes: |
  The EL406 serpentine pattern creates DETERMINISTIC temporal gradients:

  1. Processing order is fixed (A1 always first, P1 always last)
  2. Time delta between first and last well is ~4 minutes (384-well)
  3. This affects EVERY reagent addition step (fix, permeabilize, stain, wash)
  4. Cumulative effect: early wells are "over-processed", late wells "under-processed"

  Integration with Cell Painting assay:
  - Calculate well processing order from row/column
  - Compute time delta from A1 (reference well)
  - Apply time-dependent bias to stain factors
  - This is ADDITIVE to existing stain_cv (plate-level variation)

  Example: Well M23 (late in pass 1)
  - Processed at t ≈ 200s after A1
  - Gets 200s less fixation before wash → under-fixed
  - Gets 200s less staining before wash → lower signal
  - Apply ~8% negative bias to stain factor

  This gradient is LEARNABLE by agent:
  - Corner wells (A1, A24, P1, P24) show systematic bias
  - Agent can learn "A1 always runs hot, P1 always runs cold"
  - Combines with per-well biology to create well identity
