# EL406 Dispenser/Washer - Cell Culture Instrument
# Used for plate feeding and media changes
# 8-channel manifold with serpentine processing pattern

instrument_id: "el406_culture"
instrument_purpose: "cell_culture"
usage: "Plate feeding, media changes, simple plating (1 cell line per plate)"
notes: |
  Used for homogeneous plates (single cell line across entire plate).
  For complex plate maps (multiple cell lines, spatial patterns), use Certus instead.

manifold_type: "el406_8channel"
num_channels: 8
num_pins: 8

# Processing pattern: serpentine (odd rows L→R, even rows R→L)
processing_pattern:
  odd_rows: "left_to_right"   # A, C, E, G, I, K, M, O: columns 1→12/24
  even_rows: "right_to_left"  # B, D, F, H, J, L, N, P: columns 24/12→1

# Timing parameters (seconds)
timing:
  dispense_rate: 1.0         # ~1 second per well dispense
  aspiration_rate: 0.8       # ~0.8 seconds per well aspiration
  row_transition: 2.0        # 2 seconds to move to next row (odd→odd or even→even)
  pass_transition: 5.0       # 5 seconds between pass 1→pass 2 (odd rows→even rows)

# Pin-specific hardware variation (8-channel manifold)
pin_characteristics:
  num_pins: 8
  pin_to_row_mapping:
    pin_1: ["A", "I"]  # 384-well: rows A and I
    pin_2: ["B", "J"]
    pin_3: ["C", "K"]
    pin_4: ["D", "L"]
    pin_5: ["E", "M"]
    pin_6: ["F", "N"]
    pin_7: ["G", "O"]
    pin_8: ["H", "P"]

  per_pin_variation:
    volume_cv: 0.02-0.05      # 2-5% CV per pin (pin-to-pin differences)
    roughness_cv: 0.03-0.08   # 3-8% CV in cell viability from mechanical stress (when plating)
    systematic_bias: "Each pin has persistent offset from nominal volume and roughness"

  effects:
    row_specific_bias: |
      Each row gets consistent treatment from same pin:
      - Row A always uses Pin 1 (systematic volume offset, roughness characteristic)
      - Row B always uses Pin 2 (different volume offset, different roughness)
      - etc.

      Result: ROW-WISE systematic biases in:
      1. Media volume (feeding operations)
      2. Cell density (plating operations - volume variation)
      3. Cell viability (plating operations - roughness/mechanical stress)

      These biases are DETERMINISTIC and LEARNABLE:
      - Row A wells consistently get Pin 1 volume offset (+/- 2-5%)
      - Row C wells consistently get Pin 3 roughness characteristic
      - Agent can learn "Row A always runs high, Row E always runs low"

    interaction_with_serpentine_gradient: |
      Pin-specific effects MULTIPLY with serpentine temporal gradients:
      - A1: Early timing (column 1, processed first) × Pin 1 bias (row A)
      - P24: Late timing (column 24, processed last) × Pin 8 bias (row P)

      Total effect = serpentine_temporal_gradient × pin_bias

      Example: Plating operation
      - Pin 1 dispenses 3% high volume (more cells)
      - A1 is early in serpentine (+2% from timing gradient)
      - A1 gets 5.06% more cells than expected (1.03 × 1.02 = 1.0506)

      Example: Feeding operation
      - Pin 5 dispenses 2% low volume (less nutrients)
      - E1 is early in serpentine (odd row, left to right)
      - E1 gets 98% of expected media volume but with early timing advantage
      - Net effect depends on interaction of volume deficit and timing advantage

    cumulative_across_operations: |
      Pin biases persist and compound:
      1. Plating (EL406 Culture): Row A gets Pin 1 characteristics
      2. Feeding 1 (EL406 Culture): Row A gets Pin 1 characteristics AGAIN
      3. Feeding 2 (EL406 Culture): Row A gets Pin 1 characteristics AGAIN
      4. Cell Painting (different EL406): Row A gets different instrument's Pin 1

      By assay time, Row A has received Pin 1 treatment 3-4 times, compounding bias

# Parametric Unit Ops that use this EL406
parametric_unit_ops:
  - op_name: "op_feed"
    usage: "Feed cells in 96-well or 384-well plates (media change)"
    hardware: "EL406 Culture"
    temporal_gradient: true
    notes: "Uses op_aspirate (remove old media) + op_dispense (add fresh media). Serpentine pattern affects nutrient delivery timing."

  - op_name: "op_dispense"
    usage: "Dispense media, supplements, treatments"
    hardware: "EL406 Culture"
    temporal_gradient: true
    context: "cell_culture"

  - op_name: "op_aspirate"
    usage: "Remove old media, wash buffers"
    hardware: "EL406 Culture"
    temporal_gradient: true
    context: "cell_culture"

# Cell culture operations
cell_culture_operations:
  - name: "simple_plating"
    parametric_unit_ops: ["op_seed_plate"]
    sub_operations: ["op_dispense"]
    plate_formats: [96, 384]
    temporal_gradient_effect: "cell_density_gradient"
    constraint: "homogeneous_plate_only"
    notes: |
      Used ONLY for homogeneous plating (1 cell line across entire plate).
      For complex plate maps (multiple cell lines, patterns), use Certus instead.

      Cell density gradient created by serpentine pattern:
      - A1 seeded first (t=0), begins attaching/spreading immediately
      - P1 seeded last (t=240s for 384-well), 4 min delay before attaching
      - Early wells have 4-minute head start on attachment/spreading

      Effects on biology:
      - Cell density appears higher in early wells (more spreading time)
      - Growth synchronization disrupted (early wells further along)
      - Confluence timing differs (early wells reach confluence first)

      Impact: ~2-3% CV contribution from plating timing gradient
      This gradient PERSISTS throughout experiment and MULTIPLIES with feeding/painting gradients
  - name: "plate_feeding"
    parametric_unit_ops: ["op_feed"]
    sub_operations: ["op_aspirate", "op_dispense"]
    plate_formats: [96, 384]
    temporal_gradient_effect: "nutrient_delivery_timing"
    notes: |
      Feeding 96/384-well plates creates temporal gradient:
      - A1 gets fresh media first (t=0), sits longest before incubation
      - P1/H12 gets fresh media last (t=60s for 96-well, t=240s for 384-well)
      - Early wells: Media cools slightly during dispensing (~1-2°C for 384-well)
      - Late wells: Get warmer media, less time for temperature equilibration

      Effects on biology:
      - Temperature shock differential (early wells experience more shock)
      - Nutrient availability timing (late wells get fresher state)
      - Growth phase synchronization disrupted by staggered feed

      Impact: ~2-3% CV contribution for routine culture

  - name: "compound_treatment"
    parametric_unit_ops: ["op_dispense"]
    plate_formats: [96, 384]
    temporal_gradient_effect: "compound_exposure_timing"
    notes: |
      When adding compound treatments to plates:
      - A1 gets compound first (longest exposure before downstream steps)
      - P1 gets compound last (shortest exposure)
      - For fast-acting compounds, this creates dose-response artifacts
      - 4-minute spread can matter for kinase inhibitors, channel blockers

# Expected artifacts from serpentine pattern
expected_artifacts:
  gradient_type: "serpentine"

  # Wells processed first (A1, C1, E1, ...) get:
  early_wells:
    - "Fresh media first (cools ~1-2°C during plate dispense)"
    - "Longer exposure to compound (if treatment follows)"
    - "Temperature shock differential"

  # Wells processed last (B1, D1, F1, ... P1) get:
  late_wells:
    - "Fresh media last (stays warmer)"
    - "Shorter exposure to compound"
    - "Less temperature equilibration time"

  # Magnitude (typical)
  gradient_magnitude:
    min_delta_time: 0         # A1 processed first
    max_delta_time: 240       # P1 processed last (~4 min spread for 384-well)
    feeding_gradient: "2-3% CV contribution (routine culture)"
    temperature_differential: "1-2°C across plate during dispense"

# Plate format support
supported_formats:
  - plate_format: 384
    rows: ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P"]
    columns: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]
    total_dispense_time: 240  # ~4 minutes for full plate

  - plate_format: 96
    rows: ["A","B","C","D","E","F","G","H"]
    columns: [1,2,3,4,5,6,7,8,9,10,11,12]
    total_dispense_time: 60   # ~1 minute for full plate

# Implementation notes
implementation_notes: |
  EL406 Culture creates DETERMINISTIC temporal gradients for all cell culture operations.

  Key differences from EL406 Cell Painting:
  - Different instrument (independent calibration/wear)
  - Used earlier in experiment lifecycle (plating, feeding)
  - Gradients affect BIOLOGICAL state (temperature, nutrients, growth phase)
  - Cell Painting gradients affect MEASUREMENT (fixation, staining)

  Integration:
  - Calculate well processing order from row/column
  - Compute time delta from A1 (reference well)
  - Apply time-dependent bias to:
    * Temperature (cooling gradient during dispense)
    * Nutrient availability (early wells get "older" media by end of dispense)
    * Compound exposure timing (for treatments)

  Example: Well M23 (late in pass 1)
  - Gets fresh media at t ≈ 200s after A1
  - Media has cooled ~1°C vs A1
  - If compound added next, gets 200s less exposure before downstream step

  This gradient is LEARNABLE by agent and INDEPENDENT from Cell Painting EL406:
  - Culture EL406 creates biological gradient
  - Cell Painting EL406 creates measurement gradient
  - Total effect is PRODUCT of both gradients
  - Agent must learn two separate systematic artifacts
